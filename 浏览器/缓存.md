# Cookie

## 关于Cookie的概念

Cookie的出现，主要还是因为http是一种无状态的协议。所谓无状态，就是说服务器对于客户端的操作历史没有记忆能力。

没有记忆能力，则意味着我的这一步操作，和我的上一步操作之间没有任何联系。在一些会话性的场景中会导致严重的问题，比如，在购物网站我刚刚将一袋牛肉干添加到购物车，跳转一下页面购物车又清空了。比如有些操作需要登陆后才能访问，我上一步登陆了，这一步服务器又完全不记得了。

如果没有一个解决办法，服务器老是翻脸不认人，那很多东西就没法玩了。因为我们基本不可能一步操作就能干完所有的事情，比如我们买一个东西，往往是需要发很多次请求：添加到购物车要发请求，跳转到结算页面要发请求，确认收货信息要发请求，支付要发请求...这里提到的每一步的操作，都跟上一步的信息紧密关联，服务器必须清楚的知道：这个请求是谁发来的，在做什么事情，操作到哪一步了。如果有类似的购物请求发过来，服务器更应该清楚地区分：哪个请求是来自哪个客户的哪笔订单，如果这都能弄混，那就天下大乱了。

Cookie正是这样一个标识，它的出现就是为了帮助服务器去记录一些会话信息。比如：我们在京东添加了一袋熟食到购物车，这里发一个请求，请求的时候带上Cookie；下次页面刷新了，需要发一个请求去获取购物车里面的商品列表，这时候我们又在请求头上带上刚刚那个Cookie，服务器就知道这是哪个来自哪个会话了，然后就会把刚刚那次带上相同Cookie保存的熟食记录返回给客户端。这样，这个状态就玩起来了。

说白了，这就好比一群人去餐馆吃饭，有人等不及去前台催老板快点上菜，首先你得亮出你的刚刚取的号牌，老板才知道你是几号，都点了些什么菜，现在菜做到什么进度了。每个人都去催老板，老板是根据号牌去区分的，这个号牌也是餐馆前台在你下单的时候发放给你的。在这个场景中，餐馆的老板就是服务器，号码就是Cookie，而一堆客人就是各个客户端。

## Cookie的设置过程

理解了这个非常不错的餐馆例子之后，我们再来看Cookie的设置就简单多了。

1. 客户端发送一个HTTP请求到服务器；
2. 服务器接收这个请求，并在返回的响应头里设置`Set-Cookie`字段；
3. 客户端收到这个响应后，将Cookie拿出来并保存在浏览器中；
4. 根据Cookie中的域名和路径信息生成一个规则，以后发送的请求地址如果匹配上了该规则，就自动在请求头里加上Cookie字段，并将Cookie值设置上去。
5. 一直到该Cookie过期，这种现象才会停止。

## Cookie的属性

先说一下Cookie的基本格式：`name1=value1;name2=value2`。以等号连接键与值，以分号作为不同键值对的分割符。

比如`userkey=f123c;domain=.jd.com`。

- `Domain`，主机名，指定了在发往哪个主机的请求中需要在请求头携带Cookie；
- `Path`，路径，主机名+路径组成了一个URL规则，如主机名为`.v1.com`，路径为`/api`，那么访问`xxx.v1.com/api/getUserInfo`接口地址就会携带Cookie，访问`xxx.v1.com/getBannerList`则不会携带Cookie；
- `Expires`，用于设置到期时间，比如类似`Expires=Wed, 21 Aug 2020 07:28:00 GMT`这样的，需要注意的是，这个是格林尼治时间，换算成北京时间要加8个小时，因为我们在东八区；当Expires不设置，或者设置值为`Session`时，表示其为一个会话性Cookie，会在用户关闭浏览器时失效；
- `Max-Age`，用于设置有效时长，类似于`Max-Age=86400`这样的，单位为秒。需要注意Max-Age的优先级高于Expires；
- `HttpOnly`，用于设置该Cookie是否只用于Http请求中，如果设置为true，则无法通过JS获取（如`document.cookie`）；
- `Secure`，用于设置该Cookie是否只携带于https请求中，如果设置为true，则在http请求中就不会携带了。另外，在https请求中携带Cookie是不会被传输中途窃取或篡改的。

## Cookie有什么卵用

- 会话状态标识。比如购物车、在线游戏闯关、系统登录等等；
- 统计用户的浏览器行为，比如弄一些埋点，在cookie中加入一些user_id标识这样的东西。

## Cookie的缺点

- 不够安全。纯文本明文传输了解一下。当HTTPOnly为false的时候，JS脚本随便拿user_id、session_id；
- 容量有点小。只有4kB，存不了什么大东西；
- 增加传输体积。只要服务器配好了Domain和Path，所有符合条件的http/https请求都会在请求头上带上这一坨Cookie，不管服务器需不需要。